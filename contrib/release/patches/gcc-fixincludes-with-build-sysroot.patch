From 6ef0d9f16cea6b409fc8bbda59a63a5240cc5c39 Mon Sep 17 00:00:00 2001
From: dkl <daniel.c.klauer@web.de>
Date: Sat, 7 May 2016 17:31:01 +0200
Subject: [PATCH] fixincludes: Respect --with-build-sysroot

When cross-compiling a native compiler, fixincludes accessed host-specific
paths on the build system. This seems wrong and probably contaminates the
new compiler with headers from a completely unrelated system.

If build != host, fixincludes can only be done if --with-build-sysroot is
given, and then it must search the header paths inside this sysroot.

For example:
	--build=x86_64-pc-linux-gnu
	--host=i686-w64-mingw32
	--host=i686-w64-mingw32
This searched for /mingw/include, which does not exist on the GNU/Linux
build system. Instead, we should specify --with-build-sysroot=/foo, where
/foo is a i686-w64-mingw32 sysroot on the build system. Then the headers
can be found in /foo/mingw/include.
---
 gcc/Makefile.in  | 9 +++++----
 gcc/configure    | 8 ++++++--
 gcc/configure.ac | 3 +++
 3 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/gcc/Makefile.in b/gcc/Makefile.in
index 6c5adc0..17aeb06 100644
--- a/gcc/Makefile.in
+++ b/gcc/Makefile.in
@@ -428,6 +428,7 @@ GCC_FOR_TARGET = $(STAGE_CC_WRAPPER) ./xgcc -B./ -B$(build_tooldir)/bin/ -isyste
 
 # Set if the compiler was configured with --with-build-sysroot.
 SYSROOT_CFLAGS_FOR_TARGET = @SYSROOT_CFLAGS_FOR_TARGET@
+BUILD_SYSROOT_DIR = @BUILD_SYSROOT_DIR@
 
 # This is used instead of ALL_CFLAGS when compiling with GCC_FOR_TARGET.
 # It specifies -B./.
@@ -2893,11 +2894,11 @@ stmp-fixinc: gsyslimits.h macro_list fixinc_list \
 	    sysroot_headers_suffix=`echo $${ml} | sed -e 's/;.*$$//'`; \
 	    multi_dir=`echo $${ml} | sed -e 's/^[^;]*;//'`; \
 	    fix_dir=include-fixed$${multi_dir}; \
-	    if ! $(inhibit_libc) && test ! -d ${SYSTEM_HEADER_DIR}; then \
+	    if ! $(inhibit_libc) && test ! -d ${BUILD_SYSROOT_DIR}${SYSTEM_HEADER_DIR}; then \
 	      echo The directory that should contain system headers does not exist: >&2 ; \
-	      echo "  ${SYSTEM_HEADER_DIR}" >&2 ; \
+	      echo "  ${BUILD_SYSROOT_DIR}${SYSTEM_HEADER_DIR}" >&2 ; \
 	      tooldir_sysinc=`echo "${gcc_tooldir}/sys-include" | sed -e :a -e "s,[^/]*/\.\.\/,," -e ta`; \
-	      if test "x${SYSTEM_HEADER_DIR}" = "x$${tooldir_sysinc}"; \
+	      if test "x${BUILD_SYSROOT_DIR}${SYSTEM_HEADER_DIR}" = "x$${tooldir_sysinc}"; \
 	      then sleep 1; else exit 1; fi; \
 	    fi; \
 	    $(mkinstalldirs) $${fix_dir}; \
@@ -2908,7 +2909,7 @@ stmp-fixinc: gsyslimits.h macro_list fixinc_list \
 	      export TARGET_MACHINE srcdir SHELL MACRO_LIST && \
 	      cd $(build_objdir)/fixincludes && \
 	      $(SHELL) ./fixinc.sh "$${gcc_dir}/$${fix_dir}" \
-	        $(SYSTEM_HEADER_DIR) $(OTHER_FIXINCLUDES_DIRS) ); \
+	        $(BUILD_SYSROOT_DIR)$(SYSTEM_HEADER_DIR) $(OTHER_FIXINCLUDES_DIRS) ); \
 	    rm -f $${fix_dir}/syslimits.h; \
 	    if [ -f $${fix_dir}/limits.h ]; then \
 	      mv $${fix_dir}/limits.h $${fix_dir}/syslimits.h; \
diff --git a/gcc/configure b/gcc/configure
index 1c6e340..d892e4a 100755
--- a/gcc/configure
+++ b/gcc/configure
@@ -816,6 +816,7 @@ GENINSRC
 CROSS_SYSTEM_HEADER_DIR
 TARGET_SYSTEM_ROOT_DEFINE
 TARGET_SYSTEM_ROOT
+BUILD_SYSROOT_DIR
 SYSROOT_CFLAGS_FOR_TARGET
 target_subdir
 host_subdir
@@ -3479,10 +3480,12 @@ else
 fi
 
 
+BUILD_SYSROOT_DIR=
 
 # Check whether --with-build-sysroot was given.
 if test "${with_build_sysroot+set}" = set; then :
   withval=$with_build_sysroot; if test x"$withval" != x ; then
+     BUILD_SYSROOT_DIR="$withval"
      SYSROOT_CFLAGS_FOR_TARGET="--sysroot=$withval"
    fi
 else
diff --git a/gcc/configure.ac b/gcc/configure.ac
index 6c1dcd9..0f508c5 100644
--- a/gcc/configure.ac
+++ b/gcc/configure.ac
@@ -134,14 +134,17 @@ AC_ARG_WITH([native-system-header-dir],
  configured_native_system_header_dir="${withval}"
 ], [configured_native_system_header_dir=])
 
+BUILD_SYSROOT_DIR=
 AC_ARG_WITH(build-sysroot, 
   [AS_HELP_STRING([--with-build-sysroot=sysroot],
                   [use sysroot as the system root during the build])],
   [if test x"$withval" != x ; then
+     BUILD_SYSROOT_DIR="$withval"
      SYSROOT_CFLAGS_FOR_TARGET="--sysroot=$withval"
    fi],
   [SYSROOT_CFLAGS_FOR_TARGET=])
 AC_SUBST(SYSROOT_CFLAGS_FOR_TARGET)
+AC_SUBST(BUILD_SYSROOT_DIR)
 
 if test "x$prefix" = xNONE; then
  test_prefix=/usr/local
-- 
2.7.4

